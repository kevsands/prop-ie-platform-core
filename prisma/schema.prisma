generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

// ======= User Management =======

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  firstName    String
  lastName     String
  phone        String?
  password     String? // Hashed password if using local auth
  roles        UserRole[]
  status       UserStatus @default(ACTIVE)
  kycStatus    KYCStatus  @default(NOT_STARTED)
  organization String?
  position     String?
  avatar       String?
  preferences  Json?
  created      DateTime   @default(now())
  lastActive   DateTime   @updatedAt
  lastLogin    DateTime?
  metadata     Json?
  locationId   String?    // Location for users
  location     Location? @relation(fields: [locationId], references: [id])

  // Relations
  kycDocuments        Document[]    @relation("UserKycDocuments")
  ownedDevelopments   Development[] @relation("DeveloperRelation")
  investments         Investment[]  @relation("InvestorRelation")
  professionalProfile Professional? @relation("ProfessionalProfile")
  leadsSold           Sale[]        @relation("SellingAgentRelation")
  leads               Lead[]        @relation("AssignedLeads")

  teamMemberships TeamMember[]
  projectsManaged Project[]           @relation("ProjectManagerRelation")
  tasksAssigned   ProjectTask[]       @relation("AssignedTasksRelation")
  tasksCreated    ProjectTask[]       @relation("CreatedTasksRelation")
  salesMilestones SaleStatusHistory[] @relation("SaleStatusUpdatedByRelation")

  // Audit fields for various entities
  documentsUploaded Document[]        @relation("DocumentUploader")
  documentsApproved Document[]        @relation("DocumentApprover")
  updatedDocuments  DocumentVersion[] @relation("DocumentVersionCreator")
  permissions       UserPermission[]  @relation("UserPermissions")

  // First-Time Buyer related relations
  buyerProfile     BuyerProfile?
  reservations     Reservation[]
  snagLists        SnagList[]
  mortgageTracking MortgageTracking?
  
  // Development related relations
  developmentViewings DevelopmentViewing[]
  developmentReservations DevelopmentReservation[]
  developmentSales DevelopmentSale[]
  viewingAgentFor DevelopmentViewing[] @relation("ViewingAgent")
  
  // Transaction relations for different roles
  buyerTransactions     Transaction[]  @relation("BuyerTransactions")
  agentTransactions     Transaction[]  @relation("AgentTransactions")
  solicitorTransactions Transaction[]  @relation("SolicitorTransactions")
  
  // Analytics relations
  inquiries             Inquiry[]
  
  // Auth relations
  sessions      Session[]
  refreshTokens RefreshToken[]
  authLogs      AuthLog[]
  mfaSettings   MfaSettings?
  mfaTokens     MfaToken[]
}

// ======= Authentication Models =======

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([expiresAt])
}

model AuthLog {
  id        String   @id @default(cuid())
  eventType String   // LOGIN, LOGOUT, LOGIN_FAILED, TOKEN_REFRESH, MFA_CHALLENGE, etc.
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  email     String?
  ipAddress String?
  userAgent String?
  metadata  Json?
  timestamp DateTime @default(now())
  
  @@index([userId])
  @@index([eventType])
  @@index([timestamp])
}

model MfaSettings {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  enabled       Boolean  @default(false)
  method        MfaMethod @default(TOTP)
  secret        String?  // Encrypted TOTP secret
  backupCodes   String[] // Encrypted backup codes
  lastUsed      DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model MfaToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String
  type      MfaTokenType
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

enum MfaMethod {
  TOTP
  SMS
  EMAIL
}

enum MfaTokenType {
  VERIFICATION
  BACKUP
}

enum UserRole {
  DEVELOPER
  BUYER
  INVESTOR
  ARCHITECT
  ENGINEER
  QUANTITY_SURVEYOR
  LEGAL
  PROJECT_MANAGER
  AGENT
  SOLICITOR
  CONTRACTOR
  ADMIN
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum KYCStatus {
  NOT_STARTED
  IN_PROGRESS
  PENDING_REVIEW
  APPROVED
  REJECTED
}

model UserPermission {
  id         String @id @default(cuid())
  user       User   @relation("UserPermissions", fields: [userId], references: [id])
  userId     String
  resource   String
  action     String
  conditions Json?
}

model TeamMember {
  id        String    @id @default(cuid())
  team      Team      @relation(fields: [teamId], references: [id])
  teamId    String
  user      User      @relation(fields: [userId], references: [id])
  userId    String
  role      String // Role within this team
  joinDate  DateTime  @default(now())
  leaveDate DateTime?

  @@unique([teamId, userId]) // A user can be in a team only once
}

model Team {
  id          String       @id @default(cuid())
  name        String
  description String?
  projects    Project[]
  members     TeamMember[]
  permissions Json? // Team-level permissions
  created     DateTime     @default(now())
  updated     DateTime     @updatedAt

  // Organization relation would go here if needed
}

// ======= First-Time Buyer =======

model BuyerProfile {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id])
  currentJourneyPhase String   @default("planning") // planning, financing, searching, buying, moved-in
  financialDetails    Json?
  preferences         Json?
  governmentSchemes   Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model Reservation {
  id                 String    @id @default(cuid())
  propertyId         String
  property           Unit      @relation(fields: [propertyId], references: [id])
  userId             String
  user               User      @relation(fields: [userId], references: [id])
  status             String    @default("pending") // pending, confirmed, cancelled, completed
  depositAmount      Float
  depositPaid        Boolean   @default(false)
  reservationDate    DateTime  @default(now())
  agreementSigned    Boolean   @default(false)
  agreementDocument  String?
  expiryDate         DateTime?
  completionDate     DateTime?
  cancellationReason String? // Added field for storing cancellation reason
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  documents Document[]
}

model MortgageTracking {
  id                String     @id @default(cuid())
  userId            String     @unique
  user              User       @relation(fields: [userId], references: [id])
  status            String     @default("not_started") // not_started, aip_received, aip_expired, mortgage_offered, mortgage_completed
  lenderName        String?
  amount            Float?
  aipDate           DateTime?
  aipExpiryDate     DateTime?
  formalOfferDate   DateTime?
  mortgageDocuments Document[] @relation("MortgageDocuments")
  conditions        String[]
  notes             String?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
}

model SnagList {
  id         String   @id @default(cuid())
  propertyId String
  property   Unit     @relation(fields: [propertyId], references: [id])
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  status     String   @default("active") // active, completed, archived
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  items SnagItem[]
}

model SnagItem {
  id             String    @id @default(cuid())
  snagListId     String
  snagList       SnagList  @relation(fields: [snagListId], references: [id])
  description    String
  location       String // The room or area where the snag is located
  status         String    @default("pending") // pending, acknowledged, fixed, disputed
  images         String[] // URLs to images of the snag
  developerNotes String?
  fixedDate      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  sale   Sale?   @relation("SaleSnagItems", fields: [saleId], references: [id])
  saleId String?
}

model HomePackItem {
  id          String    @id @default(cuid())
  propertyId  String
  property    Unit      @relation(fields: [propertyId], references: [id])
  title       String
  category    String // warranty, manual, certificate, utility
  documentUrl String
  expiryDate  DateTime?
  issuer      String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ======= Location =======

model Location {
  id           String  @id @default(cuid())
  address      String
  addressLine1 String?
  addressLine2 String?
  city         String
  county       String
  eircode      String?
  country      String  @default("Ireland")
  longitude    Float?
  latitude     Float?

  // Relations
  developments Development[]
  users User[]
}

// ======= Development =======

model Development {
  id          String            @id @default(cuid())
  name        String
  slug        String?           @unique
  developer   User              @relation("DeveloperRelation", fields: [developerId], references: [id])
  developerId String
  location    Location          @relation(fields: [locationId], references: [id])
  locationId  String
  status      DevelopmentStatus

  // Units and accommodation
  totalUnits Int
  units      Unit[]

  // Team
  professionalTeam ProfessionalAppointment[]

  // Status tracking
  marketingStatus    Json
  salesStatus        Json
  constructionStatus Json
  complianceStatus   Json

  // Timeline and financials
  timelineId   String?          @unique
  timeline     ProjectTimeline? @relation(fields: [timelineId], references: [id])
  financialsId String?

  // Media
  mainImage      String
  images         String[]
  videos         String[]
  sitePlanUrl    String?
  brochureUrl    String?
  virtualTourUrl String?
  websiteUrl     String?

  // Content
  description      String
  shortDescription String?
  features         String[]
  amenities        String[]
  buildingSpecs    Json?

  // Additional metadata
  buildingType   String?
  completionDate DateTime?
  startDate      DateTime?
  created        DateTime  @default(now())
  updated        DateTime  @updatedAt
  publishedDate  DateTime?
  isPublished    Boolean   @default(false)
  tags           String[]
  awards         String[]

  // Relations
  documents               Document[]
  projects                Project[]
  investmentOpportunities InvestmentOpportunity[]
  campaigns               MarketingCampaign[]

  sales               Sale[]
  Investment          Investment[]
  Viewing             Viewing[]
  UnitType            UnitType[]
  DevelopmentMedia    DevelopmentMedia[]
  DevelopmentDocument DevelopmentDocument[]
  Amenity             Amenity[]
  DevelopmentUnit     DevelopmentUnit[]
  DevelopmentAmenity  DevelopmentAmenity[]
  DevelopmentViewing  DevelopmentViewing[]
  DevelopmentReservation DevelopmentReservation[]
  DevelopmentSale     DevelopmentSale[]
  
  // Transaction Management
  transactions        Transaction[]
}

enum DevelopmentStatus {
  PLANNING
  APPROVED
  PRE_CONSTRUCTION
  CONSTRUCTION
  UNDER_CONSTRUCTION
  READY
  LAUNCHED
  MARKETING
  SALES
  SELLING
  HANDOVER
  SOLD_OUT
  COMPLETED
}

model ProjectTimeline {
  id                     String       @id @default(cuid())
  development            Development?
  planningSubmissionDate DateTime
  planningDecisionDate   DateTime?
  constructionStartDate  DateTime?
  constructionEndDate    DateTime?
  marketingLaunchDate    DateTime?
  salesLaunchDate        DateTime?

  // Relations
  milestones ProjectMilestone[]
}

model ProjectMilestone {
  id          String          @id @default(cuid())
  name        String
  description String
  plannedDate DateTime
  actualDate  DateTime?
  status      MilestoneStatus
  timeline    ProjectTimeline @relation(fields: [timelineId], references: [id])
  timelineId  String

  // Relations
  dependencies ProjectMilestoneDependency[] @relation("DependsOn")
  dependents   ProjectMilestoneDependency[] @relation("DependedOnBy")
  documents    Document[]
}

model ProjectMilestoneDependency {
  id          String           @id @default(cuid())
  milestone   ProjectMilestone @relation("DependsOn", fields: [milestoneId], references: [id])
  milestoneId String
  dependsOn   ProjectMilestone @relation("DependedOnBy", fields: [dependsOnId], references: [id])
  dependsOnId String

  @@unique([milestoneId, dependsOnId])
}

enum MilestoneStatus {
  PLANNED
  IN_PROGRESS
  DELAYED
  COMPLETED
  CANCELLED
}

// ======= Unit =======

model Unit {
  id            String      @id @default(cuid())
  development   Development @relation(fields: [developmentId], references: [id])
  developmentId String

  // Link to UnitType
  unitTypeId String?
  unitType   UnitType? @relation(fields: [unitTypeId], references: [id])

  // Basic info
  unitNumber    String? // e.g., "A101", "B205"
  name          String
  type          PropertyType
  // Basic specifications
  size          Float // in square meters
  bedrooms      Int
  bathrooms     Float // 2.5 for 2 and a half bathrooms
  floors        Int
  parkingSpaces Int

  // Pricing and status
  basePrice Float
  price     Float?
  status    UnitStatus

  // Features
  berRating String
  features  String[]

  // Media
  primaryImage   String
  images         String[]
  floorplans     String[]
  virtualTourUrl String?

  // Additional details
  block              String?
  floor              Int?
  aspect             String?
  availableFrom      DateTime?
  reservationEndDate DateTime?
  lastViewed         DateTime?
  viewCount          Int       @default(0)
  updatedAt          DateTime  @updatedAt
  slug               String?

  // Relations
  outdoorSpaces           UnitOutdoorSpace[]
  rooms                   UnitRoom[]
  customizationOptions    UnitCustomizationOption[]
  customizationSelections CustomizationSelection[]
  customizations          Customization[]
  sales                   Sale[]
  viewings                Viewing[]
  investorWatchlists      InvestorWatchlistUnit[]
  documents               Document[]                @relation("UnitDocuments")
  reservations            Reservation[]
  snagLists               SnagList[]
  homePackItems           HomePackItem[]
  
  // Transaction Management
  transactions            Transaction[]
  
  // Analytics relations
  propertyViews           PropertyView[]
  inquiries               Inquiry[]
}

enum PropertyType {
  APARTMENT
  HOUSE
  DUPLEX
  SEMI_DETACHED
  DETACHED
  TERRACED
  PENTHOUSE
  COMMERCIAL
  RETAIL
  OFFICE
}

enum UnitStatus {
  PLANNED
  UNDER_CONSTRUCTION
  COMPLETE
  AVAILABLE
  RESERVED
  SALE_AGREED
  SOLD
  OCCUPIED
}

model UnitOutdoorSpace {
  id          String           @id @default(cuid())
  unit        Unit             @relation(fields: [unitId], references: [id])
  unitId      String
  type        OutdoorSpaceType
  size        Float
  orientation String?
  description String?
  features    String[]
  images      String[]
}

enum OutdoorSpaceType {
  BALCONY
  TERRACE
  GARDEN
  PATIO
  ROOF_TERRACE
  YARD
}

model UnitRoom {
  id       String   @id @default(cuid())
  unit     Unit     @relation(fields: [unitId], references: [id])
  unitId   String
  name     String
  type     RoomType
  size     Float
  length   Float?
  width    Float?
  features String[]
  images   String[]
}

enum RoomType {
  LIVING_ROOM
  KITCHEN
  DINING_ROOM
  BEDROOM
  BATHROOM
  EN_SUITE
  STUDY
  UTILITY
  HALL
  LANDING
  STORAGE
  OTHER
}

model UnitCustomizationOption {
  id                    String                @id @default(cuid())
  unit                  Unit                  @relation(fields: [unitId], references: [id])
  unitId                String
  category              CustomizationCategory
  name                  String
  description           String
  baseOption            Boolean
  additionalCost        Float
  images                String[]
  modelPath             String?
  installationTimeframe Int?
  supplierInfo          Json?
  specificationDetails  String?
  dimensions            Json?
  technicalRequirements String?
  maintenanceInfo       String?
  warrantyPeriod        Int?

  // Relations
  selections       SelectedOption[]
  alternatives     UnitCustomizationOptionAlternative[]     @relation("AlternativeRelation")
  alternativeOf    UnitCustomizationOptionAlternative[]     @relation("AlternativeOfRelation")
  requiredWith     UnitCustomizationOptionRequirement[]     @relation("RequiredWithRelation")
  requiresOption   UnitCustomizationOptionRequirement[]     @relation("RequiresOptionRelation")
  incompatibleWith UnitCustomizationOptionIncompatibility[] @relation("IncompatibleWithRelation")
  incompatibleOf   UnitCustomizationOptionIncompatibility[] @relation("IncompatibleOfRelation")
}

enum CustomizationCategory {
  KITCHEN
  BATHROOM
  FLOORING
  DOORS
  WINDOWS
  PAINT
  ELECTRICAL
  HEATING
  STORAGE
  FIXTURES
  EXTERIOR
  SMART_HOME
  APPLIANCES
  LIGHTING
  OTHER
}

model UnitCustomizationOptionAlternative {
  id                  String                  @id @default(cuid())
  option              UnitCustomizationOption @relation("AlternativeRelation", fields: [optionId], references: [id])
  optionId            String
  alternativeOption   UnitCustomizationOption @relation("AlternativeOfRelation", fields: [alternativeOptionId], references: [id])
  alternativeOptionId String

  @@unique([optionId, alternativeOptionId])
}

model UnitCustomizationOptionRequirement {
  id               String                  @id @default(cuid())
  option           UnitCustomizationOption @relation("RequiredWithRelation", fields: [optionId], references: [id])
  optionId         String
  requiredOption   UnitCustomizationOption @relation("RequiresOptionRelation", fields: [requiredOptionId], references: [id])
  requiredOptionId String

  @@unique([optionId, requiredOptionId])
}

model UnitCustomizationOptionIncompatibility {
  id                   String                  @id @default(cuid())
  option               UnitCustomizationOption @relation("IncompatibleWithRelation", fields: [optionId], references: [id])
  optionId             String
  incompatibleOption   UnitCustomizationOption @relation("IncompatibleOfRelation", fields: [incompatibleOptionId], references: [id])
  incompatibleOptionId String

  @@unique([optionId, incompatibleOptionId])
}

model CustomizationSelection {
  id            String              @id @default(cuid())
  unit          Unit                @relation(fields: [unitId], references: [id])
  unitId        String
  buyer         String // User ID
  status        CustomizationStatus
  totalCost     Float
  notes         String?
  submittedDate DateTime?
  approvedDate  DateTime?
  deadlineDate  DateTime?
  meetingBooked Boolean             @default(false)
  meetingDate   DateTime?
  
  // Transaction relation
  transactionId String?
  transaction   Transaction?        @relation(fields: [transactionId], references: [id])

  // Relations
  selections SelectedOption[]
  documents  Document[]
}

model SelectedOption {
  id          String                  @id @default(cuid())
  selection   CustomizationSelection  @relation(fields: [selectionId], references: [id])
  selectionId String
  option      UnitCustomizationOption @relation(fields: [optionId], references: [id])
  optionId    String
  location    String?
  notes       String?
  color       String?
  finish      String?
  quantity    Int                     @default(1)
}

enum CustomizationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  CHANGES_REQUESTED
  APPROVED
  REJECTED
  EXPIRED
  IN_PROGRESS
  COMPLETED
}

// ======= Document Management =======

model Document {
  id                String    @id @default(cuid())
  name              String
  description       String?
  type              String // DocumentType enum in the TypeScript model
  status            String // DocumentStatus enum in the TypeScript model
  category          String // DocumentCategory enum in the TypeScript model
  fileUrl           String
  fileType          String
  fileSize          Int
  uploadedBy        User      @relation("DocumentUploader", fields: [uploadedById], references: [id])
  uploadedById      String
  uploadedByName    String?
  uploadDate        DateTime  @default(now())
  expiryDate        DateTime?
  tags              String[]
  version           Int       @default(1)
  relatedTo         Json? // RelatedEntity in the TypeScript model
  metadata          Json?
  signatureRequired Boolean   @default(false)
  signatureStatus   String?
  organizationId    String?

  // Relations
  kycUsers                User[]                   @relation("UserKycDocuments")
  development             Development?             @relation(fields: [developmentId], references: [id])
  developmentId           String?
  unit                    Unit?                    @relation("UnitDocuments", fields: [unitId], references: [id])
  unitId                  String?
  sale                    Sale?                    @relation(fields: [saleId], references: [id])
  saleId                  String?
  milestones              ProjectMilestone[]
  customizationSelections CustomizationSelection[]

  approvedBy   User?   @relation("DocumentApprover", fields: [approvedById], references: [id])
  approvedById String?

  previousVersions   DocumentVersion[]
  signatures         DocumentSignature[]
  workflow           DocumentWorkflowInstance?
  reservation        Reservation?              @relation(fields: [reservationId], references: [id])
  reservationId      String?
  mortgageTracking   MortgageTracking?         @relation("MortgageDocuments", fields: [mortgageTrackingId], references: [id])
  mortgageTrackingId String?
}

model DocumentVersion {
  id            String   @id @default(cuid())
  document      Document @relation(fields: [documentId], references: [id])
  documentId    String
  versionNumber Int
  fileUrl       String
  createdBy     User     @relation("DocumentVersionCreator", fields: [createdById], references: [id])
  createdById   String
  created       DateTime @default(now())
  notes         String?
  changes       String?
  size          Int
  checksum      String?
}

model DocumentWorkflow {
  id            String   @id @default(cuid())
  name          String
  description   String?
  documentTypes String[] // Array of DocumentType enum values
  isDefault     Boolean  @default(false)
  created       DateTime @default(now())
  updated       DateTime @updatedAt
  createdBy     String // User ID

  // Relations
  stages    DocumentWorkflowStage[]
  instances DocumentWorkflowInstance[]
}

model DocumentWorkflowStage {
  id            String  @id @default(cuid())
  name          String
  description   String?
  order         Int
  isOptional    Boolean @default(false)
  timeoutDays   Int?
  notifyOnEntry Boolean @default(true)
  notifyOnExit  Boolean @default(false)

  // Relations
  workflow     DocumentWorkflow          @relation(fields: [workflowId], references: [id])
  workflowId   String
  approvers    ApproverConfig[]
  customFields DocumentCustomField[]
  history      DocumentWorkflowHistory[]
}

model ApproverConfig {
  id              String  @id @default(cuid())
  approverType    String // 'user', 'role', 'team'
  approverId      String
  approverName    String?
  requirementType String // 'any', 'all'
  canDelegate     Boolean @default(false)

  // Relations
  stage   DocumentWorkflowStage @relation(fields: [stageId], references: [id])
  stageId String
}

model DocumentCustomField {
  id                String   @id @default(cuid())
  name              String
  description       String?
  fieldType         String // 'text', 'number', 'date', 'boolean', 'select', 'multiselect'
  isRequired        Boolean  @default(false)
  options           String[]
  defaultValue      String?
  validationRegex   String?
  validationMessage String?

  // Relations
  stage   DocumentWorkflowStage @relation(fields: [stageId], references: [id])
  stageId String
}

model DocumentWorkflowInstance {
  id                String           @id @default(cuid())
  document          Document         @relation(fields: [documentId], references: [id])
  documentId        String           @unique // Each document has at most one active workflow
  workflow          DocumentWorkflow @relation(fields: [workflowId], references: [id])
  workflowId        String
  currentStageId    String?
  status            String // 'in_progress', 'approved', 'rejected', 'cancelled'
  startDate         DateTime         @default(now())
  endDate           DateTime?
  dueDate           DateTime?
  customFieldValues Json?
  notes             String?

  // Relations
  history DocumentWorkflowHistory[]
}

model DocumentWorkflowHistory {
  id          String                   @id @default(cuid())
  instance    DocumentWorkflowInstance @relation(fields: [instanceId], references: [id])
  instanceId  String
  stage       DocumentWorkflowStage    @relation(fields: [stageId], references: [id])
  stageId     String
  enteredDate DateTime                 @default(now())
  exitDate    DateTime?
  status      String // 'pending', 'approved', 'rejected', 'skipped'
  notes       String?

  // Relations
  approvals DocumentApproval[]
}

model DocumentApproval {
  id            String                  @id @default(cuid())
  history       DocumentWorkflowHistory @relation(fields: [historyId], references: [id])
  historyId     String
  approverId    String // User ID
  decision      String // 'approved', 'rejected', 'delegated'
  timestamp     DateTime                @default(now())
  notes         String?
  delegatedToId String? // User ID if delegated
}

model DocumentSignature {
  id                 String   @id @default(cuid())
  document           Document @relation(fields: [documentId], references: [id])
  documentId         String
  signerId           String // User ID
  signatureDate      DateTime @default(now())
  signatureImageUrl  String?
  signaturePosition  Json?
  signatureMethod    String // 'click_to_sign', 'draw', 'certificate', 'third_party'
  ipAddress          String?
  verified           Boolean  @default(false)
  verificationMethod String?
  certificateUrl     String?
}

// ======= Sales =======

model Sale {
  id               String  @id @default(cuid())
  unit             Unit    @relation(fields: [unitId], references: [id])
  unitId           String
  buyerId          String // User ID
  sellingAgent     User?   @relation("SellingAgentRelation", fields: [sellingAgentId], references: [id])
  sellingAgentId   String?
  solicitorId      String? // User ID
  buyerSolicitorId String? // User ID

  // Status and timeline
  status         SaleStatus
  contractStatus String // ContractStatus enum in the TypeScript model

  // Financial details
  basePrice         Float
  customizationCost Float
  totalPrice        Float

  // Documents
  documents Document[]

  // Dates
  completionDate    DateTime?
  handoverDate      DateTime?
  keyCollectionDate DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Additional metadata
  referenceNumber String
  metadata        Json?
  tags            String[]

  // Relations
  statusHistory   SaleStatusHistory[]
  timeline        SaleTimeline?
  depositInfo     Deposit?
  mortgageDetails MortgageDetails?
  htbDetails      HTBDetails?
  notes           SaleNote[]
  tasks           SaleTask[]
  snagList        SnagItem[]          @relation("SaleSnagItems")
  development     Development         @relation(fields: [developmentId], references: [id])
  developmentId   String
}

enum SaleStatus {
  ENQUIRY
  VIEWING_SCHEDULED
  VIEWED
  INTERESTED
  RESERVATION
  PENDING_APPROVAL
  RESERVATION_APPROVED
  CONTRACT_ISSUED
  CONTRACT_SIGNED
  DEPOSIT_PAID
  MORTGAGE_APPROVED
  CLOSING
  COMPLETED
  HANDED_OVER
  CANCELLED
  EXPIRED
}

model SaleStatusHistory {
  id             String   @id @default(cuid())
  sale           Sale     @relation(fields: [saleId], references: [id])
  saleId         String
  status         String // SaleStatus enum in the TypeScript model
  previousStatus String? // SaleStatus enum in the TypeScript model
  timestamp      DateTime @default(now())
  updatedBy      User     @relation("SaleStatusUpdatedByRelation", fields: [updatedById], references: [id])
  updatedById    String
  notes          String?
}

model SaleTimeline {
  id                     String    @id @default(cuid())
  sale                   Sale      @relation(fields: [saleId], references: [id])
  saleId                 String    @unique
  initialEnquiryDate     DateTime?
  firstViewingDate       DateTime?
  reservationDate        DateTime?
  reservationExpiryDate  DateTime?
  contractIssuedDate     DateTime?
  contractReturnDeadline DateTime?
  contractReturnedDate   DateTime?
  depositDueDate         DateTime?
  depositPaidDate        DateTime?
  mortgageApprovalDate   DateTime?
  closingDate            DateTime?
  fundsDisbursedDate     DateTime?
  saleCompletedDate      DateTime?
  handoverDate           DateTime?
  keyCollectionDate      DateTime?
  warrantyStartDate      DateTime?
  warrantyEndDate        DateTime?
}

model Deposit {
  id                      String    @id @default(cuid())
  sale                    Sale      @relation(fields: [saleId], references: [id])
  saleId                  String    @unique
  initialAmount           Float
  initialAmountPercentage Float
  initialPaidDate         DateTime?
  balanceAmount           Float
  balanceDueDate          DateTime?
  balancePaidDate         DateTime?
  totalPaid               Float
  status                  String // DepositStatus enum in the TypeScript model
  paymentMethod           String?
  receiptDocumentIds      String[] // Document IDs
}

model MortgageDetails {
  id                      String    @id @default(cuid())
  sale                    Sale      @relation(fields: [saleId], references: [id])
  saleId                  String    @unique
  lender                  String
  amount                  Float
  term                    Int // in years
  interestRate            Float
  approvalInPrincipleDate DateTime?
  finalApprovalDate       DateTime?
  status                  String // MortgageStatus enum in the TypeScript model
  broker                  String?
  brokerFee               Float?
  loanType                String // MortgageType enum in the TypeScript model
  documentIds             String[] // Document IDs
  notes                   String?
  applicationDate         DateTime?
  offerExpiryDate         DateTime?
  completionDate          DateTime?
  drawdownDate            DateTime?
}

model HTBDetails {
  id                  String    @id @default(cuid())
  sale                Sale      @relation(fields: [saleId], references: [id])
  saleId              String    @unique
  applicationNumber   String
  status              String // HTBClaimStatus enum in the TypeScript model
  applicationDate     DateTime
  approvalDate        DateTime?
  amount              Float
  claimSubmissionDate DateTime?
  claimPaymentDate    DateTime?
  documentIds         String[] // Document IDs
  notes               String?
  accessCode          String?
  claimCode           String?
  expiryDate          DateTime?
}

model SaleNote {
  id        String   @id @default(cuid())
  sale      Sale     @relation(fields: [saleId], references: [id])
  saleId    String
  authorId  String // User ID
  content   String   @db.Text
  timestamp DateTime @default(now())
  isPrivate Boolean  @default(false)
  category  String?
}

model SaleTask {
  id               String    @id @default(cuid())
  sale             Sale      @relation(fields: [saleId], references: [id])
  saleId           String
  title            String
  description      String
  dueDate          DateTime
  status           String // SaleTaskStatus enum in the TypeScript model
  priority         String // SaleTaskPriority enum in the TypeScript model
  assignedToId     String // User ID
  createdById      String // User ID
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  completedAt      DateTime?
  completedById    String? // User ID
  notifyBeforeDays Int?
  isReminderSent   Boolean   @default(false)
  recurrence       Json? // TaskRecurrence in the TypeScript model
}

// ======= Professional =======

model Professional {
  id               String   @id @default(cuid())
  user             User     @relation("ProfessionalProfile", fields: [userId], references: [id])
  userId           String   @unique
  companyId        String
  company          Company  @relation(fields: [companyId], references: [id])
  specializations  String[] // ProfessionalSpecialization enum values
  status           String // ProfessionalStatus enum in the TypeScript model
  licenseNumber    String?
  insuranceDetails Json?
  professionalBio  String?
  website          String?
  created          DateTime @default(now())
  updated          DateTime @updatedAt

  // Relations
  qualifications Qualification[]
  documents      ProfessionalDocument[]
  appointments   ProfessionalAppointment[]
  assignments    ProfessionalAssignment[]
  reviews        ProfessionalReview[]
}

model Company {
  id               String    @id @default(cuid())
  name             String
  address          String
  phone            String
  email            String
  website          String?
  description      String?
  logo             String?
  vatNumber        String?
  companyNumber    String
  establishedDate  DateTime?
  insuranceDetails Json?
  certifications   String[]
  created          DateTime  @default(now())
  updated          DateTime  @updatedAt

  // Relations
  professionals Professional[]
  serviceAreas  ServiceArea[]
}

model ServiceArea {
  id        String   @id @default(cuid())
  company   Company  @relation(fields: [companyId], references: [id])
  companyId String
  county    String
  cities    String[]
}

model Qualification {
  id                    String       @id @default(cuid())
  professional          Professional @relation(fields: [professionalId], references: [id])
  professionalId        String
  title                 String
  issuingBody           String
  dateObtained          DateTime
  expiryDate            DateTime?
  certificateDocumentId String?
  verificationUrl       String?
  isVerified            Boolean      @default(false)
}

model ProfessionalDocument {
  id             String       @id @default(cuid())
  professional   Professional @relation(fields: [professionalId], references: [id])
  professionalId String
  documentId     String // Document ID
  type           String
  uploadDate     DateTime     @default(now())
  expiryDate     DateTime?
  isVerified     Boolean      @default(false)
}

model ProfessionalAppointment {
  id                 String       @id @default(cuid())
  development        Development  @relation(fields: [developmentId], references: [id])
  developmentId      String
  professional       Professional @relation(fields: [professionalId], references: [id])
  professionalId     String
  role               String // ProfessionalRole enum in the TypeScript model
  appointmentDate    DateTime     @default(now())
  endDate            DateTime?
  status             String // AppointmentStatus enum in the TypeScript model
  contractDocumentId String? // Document ID
  feeStructure       Json?
  responsibilities   String[]
  notes              String?
  created            DateTime     @default(now())
  updated            DateTime     @updatedAt
}

model ProfessionalAssignment {
  id             String       @id @default(cuid())
  professional   Professional @relation(fields: [professionalId], references: [id])
  professionalId String
  role           String // ProfessionalRole enum in the TypeScript model
  saleId         String // Sale ID
  assignedDate   DateTime     @default(now())
  endDate        DateTime?
  status         String // AssignmentStatus enum in the TypeScript model
  notes          String?
  created        DateTime     @default(now())
  updated        DateTime     @updatedAt
}

model ProfessionalReview {
  id             String       @id @default(cuid())
  professional   Professional @relation(fields: [professionalId], references: [id])
  professionalId String
  reviewerId     String // User ID
  developmentId  String? // Development ID
  saleId         String? // Sale ID
  rating         Int // 1-5
  comment        String
  reviewDate     DateTime     @default(now())
  isPublic       Boolean      @default(true)
  isVerified     Boolean      @default(false)
  response       String?
  responseDate   DateTime?
}

// ======= Project =======

model Project {
  id            String      @id @default(cuid())
  development   Development @relation(fields: [developmentId], references: [id])
  developmentId String
  name          String
  description   String
  status        String // ProjectStatus enum in the TypeScript model

  // Timeline
  plannedStartDate DateTime
  plannedEndDate   DateTime
  actualStartDate  DateTime?
  actualEndDate    DateTime?

  // Management
  projectManager      User    @relation("ProjectManagerRelation", fields: [projectManagerId], references: [id])
  projectManagerId    String
  assignedCertifierId String? // Professional ID

  // Structure and tracking
  completionPercentage Float  @default(0)
  constructionStage    String // ConstructionStage enum in the TypeScript model

  // Metadata
  createdBy  String // User ID
  created    DateTime @default(now())
  updated    DateTime @updatedAt
  isArchived Boolean  @default(false)

  // Relations
  teams            Team[]
  phases           ProjectPhase[]
  milestones       ProjectMilestone2[]
  risks            ProjectRisk[]
  issues           ProjectIssue[]
  tasks            ProjectTask[]
  constructionLogs ConstructionLog[]
  inspections      Inspection[]
  updates          ProjectUpdate[]
  meetings         Meeting[]
  healthAndSafety  HealthAndSafetyPlan?
}

model ProjectPhase {
  id                   String    @id @default(cuid())
  project              Project   @relation(fields: [projectId], references: [id])
  projectId            String
  name                 String
  description          String
  orderIndex           Int
  status               String // PhaseStatus enum in the TypeScript model
  plannedStartDate     DateTime
  plannedEndDate       DateTime
  actualStartDate      DateTime?
  actualEndDate        DateTime?
  completionPercentage Float     @default(0)
  documentIds          String[] // Document IDs

  // Relations
  milestones   ProjectMilestone2[]
  tasks        ProjectTask[]
  dependencies ProjectPhaseDependency[] @relation("PhaseDependsOn")
  dependents   ProjectPhaseDependency[] @relation("PhaseDependedOnBy")
}

model ProjectPhaseDependency {
  id          String       @id @default(cuid())
  phase       ProjectPhase @relation("PhaseDependsOn", fields: [phaseId], references: [id])
  phaseId     String
  dependsOn   ProjectPhase @relation("PhaseDependedOnBy", fields: [dependsOnId], references: [id])
  dependsOnId String
  type        String // 'finish_to_start', 'start_to_start', etc.

  @@unique([phaseId, dependsOnId])
}

model ProjectMilestone2 {
  id                 String        @id @default(cuid())
  project            Project       @relation(fields: [projectId], references: [id])
  projectId          String
  phase              ProjectPhase? @relation(fields: [phaseId], references: [id])
  phaseId            String?
  name               String
  description        String
  plannedDate        DateTime
  actualDate         DateTime?
  status             String // MilestoneStatus enum in the TypeScript model
  isKeyMilestone     Boolean       @default(false)
  notifyStakeholders Boolean       @default(true)
  responsiblePartyId String // User ID
  verificationMethod String
  completionCriteria String[]
  documentIds        String[] // Document IDs

  // Relations
  dependencies ProjectMilestoneDependency2[] @relation("MilestoneDependsOn")
  dependents   ProjectMilestoneDependency2[] @relation("MilestoneDependedOnBy")
}

model ProjectMilestoneDependency2 {
  id          String            @id @default(cuid())
  milestone   ProjectMilestone2 @relation("MilestoneDependsOn", fields: [milestoneId], references: [id])
  milestoneId String
  dependsOn   ProjectMilestone2 @relation("MilestoneDependedOnBy", fields: [dependsOnId], references: [id])
  dependsOnId String

  @@unique([milestoneId, dependsOnId])
}

model ProjectTask {
  id                 String        @id @default(cuid())
  title              String
  description        String
  project            Project       @relation(fields: [projectId], references: [id])
  projectId          String
  phase              ProjectPhase? @relation(fields: [phaseId], references: [id])
  phaseId            String?
  status             String // TaskStatus enum in the TypeScript model
  priority           String // TaskPriority enum in the TypeScript model
  assignedTo         User          @relation("AssignedTasksRelation", fields: [assignedToId], references: [id])
  assignedToId       String
  createdBy          User          @relation("CreatedTasksRelation", fields: [createdById], references: [id])
  createdById        String
  plannedStartDate   DateTime
  plannedEndDate     DateTime
  actualStartDate    DateTime?
  actualEndDate      DateTime?
  estimatedHours     Float
  actualHours        Float?
  progressPercentage Float         @default(0)
  relatedTo          Json? // { type: 'unit' | 'issue' | 'risk', id: string }
  tags               String[]
  created            DateTime      @default(now())
  updated            DateTime      @updatedAt
  isOnCriticalPath   Boolean       @default(false)

  // Relations
  dependencies  ProjectTaskDependency[] @relation("TaskDependsOn")
  dependents    ProjectTaskDependency[] @relation("TaskDependedOnBy")
  subtasks      ProjectTask[]           @relation("SubtaskRelation")
  parentTask    ProjectTask?            @relation("SubtaskRelation", fields: [parentTaskId], references: [id])
  parentTaskId  String?
  comments      TaskComment[]
  attachmentIds String[] // Document IDs
}

model ProjectTaskDependency {
  id          String      @id @default(cuid())
  task        ProjectTask @relation("TaskDependsOn", fields: [taskId], references: [id])
  taskId      String
  dependsOn   ProjectTask @relation("TaskDependedOnBy", fields: [dependsOnId], references: [id])
  dependsOnId String

  @@unique([taskId, dependsOnId])
}

model TaskComment {
  id                 String            @id @default(cuid())
  task               ProjectTask       @relation(fields: [taskId], references: [id])
  taskId             String
  userId             String // User ID
  content            String
  timestamp          DateTime          @default(now())
  attachmentIds      String[] // Document IDs
  mentions           String[] // User IDs
  edited             Boolean           @default(false)
  editedAt           DateTime?
  ConveyancingTask   ConveyancingTask? @relation(fields: [conveyancingTaskId], references: [id])
  conveyancingTaskId String?
}

model ProjectRisk {
  id                     String   @id @default(cuid())
  project                Project  @relation(fields: [projectId], references: [id])
  projectId              String
  title                  String
  description            String
  category               String // RiskCategory enum in the TypeScript model
  probability            String // RiskProbability enum in the TypeScript model
  impact                 String // RiskImpact enum in the TypeScript model
  severity               Int
  status                 String // RiskStatus enum in the TypeScript model
  ownerId                String // User ID
  identifiedDate         DateTime @default(now())
  identifiedById         String // User ID
  lastUpdated            DateTime @updatedAt
  updatedById            String // User ID
  mitigationStrategy     String
  mitigationTaskIds      String[] // ProjectTask IDs
  contingencyPlan        String
  contingencyBudget      Float?
  earlyWarningIndicators String[]
  affectedAreas          String[]
  riskRegisterRanking    Int
  isArchived             Boolean  @default(false)
}

model ProjectIssue {
  id                   String    @id @default(cuid())
  project              Project   @relation(fields: [projectId], references: [id])
  projectId            String
  title                String
  description          String
  category             String // IssueCategory enum in the TypeScript model
  severity             String // IssueSeverity enum in the TypeScript model
  status               String // IssueStatus enum in the TypeScript model
  priority             String // TaskPriority enum in the TypeScript model
  reportedDate         DateTime  @default(now())
  reportedById         String // User ID
  assignedToId         String // User ID
  dueDate              DateTime?
  resolvedDate         DateTime?
  resolutionDetails    String?
  impact               String
  rootCause            String?
  preventativeMeasures String?
  relatedRiskIds       String[] // ProjectRisk IDs
  resolutionTaskIds    String[] // ProjectTask IDs
  affectedUnitIds      String[] // Unit IDs
  documentIds          String[] // Document IDs
  isEscalated          Boolean   @default(false)
  escalationLevel      Int?
  escalatedToId        String? // User ID

  // Relations
  comments IssueComment[]
}

model IssueComment {
  id            String       @id @default(cuid())
  issue         ProjectIssue @relation(fields: [issueId], references: [id])
  issueId       String
  userId        String // User ID
  content       String
  timestamp     DateTime     @default(now())
  attachmentIds String[] // Document IDs
  isInternal    Boolean      @default(false)
  edited        Boolean      @default(false)
  editedAt      DateTime?
}

model ConstructionLog {
  id                 String    @id @default(cuid())
  project            Project   @relation(fields: [projectId], references: [id])
  projectId          String
  date               DateTime  @default(now())
  authorId           String // User ID
  weather            Json
  crews              Json[]
  equipment          Json[]
  workCompleted      Json[]
  materials          Json[]
  delays             Json[]
  visitors           Json[]
  safetyIncidents    Json[]
  qualityIssues      Json[]
  notes              String
  photoIds           String[] // Document IDs
  nextDayPlan        String
  issues             String[]
  submittedTimestamp DateTime  @default(now())
  approvedById       String? // User ID
  approvedTimestamp  DateTime?
}

model Inspection {
  id                   String    @id @default(cuid())
  project              Project   @relation(fields: [projectId], references: [id])
  projectId            String
  type                 String // InspectionType enum in the TypeScript model
  inspectorId          String // User ID
  inspectorRole        String
  scheduled            DateTime
  completed            DateTime?
  location             String
  unitId               String? // Unit ID
  status               String // InspectionStatus enum in the TypeScript model
  result               String? // InspectionResult enum in the TypeScript model
  notes                String
  photoIds             String[] // Document IDs
  documentIds          String[] // Document IDs
  followUpRequired     Boolean   @default(false)
  followUpDate         DateTime?
  followUpInspectionId String?
  isReinspection       Boolean   @default(false)
  previousInspectionId String?
  created              DateTime  @default(now())
  createdById          String // User ID
  updated              DateTime  @updatedAt
  updatedById          String // User ID

  // Relations
  findings InspectionFinding[]
}

model InspectionFinding {
  id                   String     @id @default(cuid())
  inspection           Inspection @relation(fields: [inspectionId], references: [id])
  inspectionId         String
  category             String
  description          String
  location             String
  severity             String // 'minor', 'major', 'critical'
  action               String // 'none', 'monitor', 'repair', 'replace'
  photoIds             String[] // Document IDs
  assignedToId         String? // User ID
  dueDate              DateTime?
  status               String // 'open', 'in_progress', 'closed'
  closedDate           DateTime?
  closedById           String? // User ID
  verificationRequired Boolean    @default(false)
  verifiedById         String? // User ID
  verifiedDate         DateTime?
}

model ProjectUpdate {
  id                   String   @id @default(cuid())
  project              Project  @relation(fields: [projectId], references: [id])
  projectId            String
  title                String
  content              String
  authorId             String // User ID
  timestamp            DateTime @default(now())
  type                 String // UpdateType enum in the TypeScript model
  visibleTo            String[] // Array of 'project_team', 'management', etc.
  attachmentIds        String[] // Document IDs
  affectedPhaseIds     String[] // ProjectPhase IDs
  affectedMilestoneIds String[] // ProjectMilestone2 IDs
  tags                 String[]
}

model Meeting {
  id                 String   @id @default(cuid())
  project            Project  @relation(fields: [projectId], references: [id])
  projectId          String
  title              String
  type               String // MeetingType enum in the TypeScript model
  date               DateTime
  startTime          String
  endTime            String
  location           String
  isVirtual          Boolean  @default(false)
  virtualMeetingLink String?
  organizerId        String // User ID
  recurrence         Json?
  documentIds        String[] // Document IDs
  created            DateTime @default(now())
  updated            DateTime @updatedAt
  status             String // 'scheduled', 'in_progress', 'completed', 'cancelled'

  // Relations
  attendees MeetingAttendee[]
  agenda    AgendaItem[]
  minutes   MeetingMinutes?
}

model MeetingAttendee {
  id        String   @id @default(cuid())
  meeting   Meeting  @relation(fields: [meetingId], references: [id])
  meetingId String
  userId    String // User ID
  required  Boolean  @default(true)
  attended  Boolean?
}

model AgendaItem {
  id          String   @id @default(cuid())
  meeting     Meeting  @relation(fields: [meetingId], references: [id])
  meetingId   String
  topic       String
  description String?
  presenterId String // User ID
  duration    Int // in minutes
  order       Int
  documentIds String[] // Document IDs
  status      String // 'pending', 'in_progress', 'completed', 'deferred'
}

model MeetingMinutes {
  id            String    @id @default(cuid())
  meeting       Meeting   @relation(fields: [meetingId], references: [id])
  meetingId     String    @unique
  attendees     String[] // User IDs
  absentees     String[] // User IDs
  discussions   Json[]
  approvedById  String? // User ID
  approvedDate  DateTime?
  distributedOn DateTime?
  distributedTo String[] // User IDs

  // Relations
  actionItems MeetingActionItem[]
}

model MeetingActionItem {
  id            String         @id @default(cuid())
  minutes       MeetingMinutes @relation(fields: [minutesId], references: [id])
  minutesId     String
  description   String
  assignedToId  String // User ID
  dueDate       DateTime
  priority      String // TaskPriority enum in the TypeScript model
  status        String // 'pending', 'in_progress', 'completed', 'delayed'
  completedDate DateTime?
  notes         String?
  relatedTaskId String? // ProjectTask ID
}

model HealthAndSafetyPlan {
  id                  String   @id @default(cuid())
  project             Project  @relation(fields: [projectId], references: [id])
  projectId           String   @unique
  documentUrl         String
  version             String
  approvedById        String // User ID
  approvedDate        DateTime
  lastReviewDate      DateTime
  nextReviewDate      DateTime
  responsiblePersonId String // User ID
  riskAssessmentIds   String[] // Document IDs

  // Relations
  emergencyContacts EmergencyContact[]
  safetyInspections SafetyInspection[]
  incidents         SafetyIncident[]
  trainingRecords   TrainingRecord[]
  toolboxTalks      ToolboxTalk[]
}

model EmergencyContact {
  id                  String              @id @default(cuid())
  healthAndSafetyPlan HealthAndSafetyPlan @relation(fields: [planId], references: [id])
  planId              String
  name                String
  role                String
  phoneNumber         String
  email               String
  company             String?
  isOnSite            Boolean             @default(false)
}

model SafetyInspection {
  id                  String              @id @default(cuid())
  healthAndSafetyPlan HealthAndSafetyPlan @relation(fields: [planId], references: [id])
  planId              String
  date                DateTime
  inspectorId         String // User ID
  location            String
  type                String // 'daily', 'weekly', 'monthly', 'special'
  items               Json[]
  issues              Json[]
  score               Int?
  notes               String
  signature           String
  documentIds         String[] // Document IDs
}

model SafetyIncident {
  id                        String              @id @default(cuid())
  healthAndSafetyPlan       HealthAndSafetyPlan @relation(fields: [planId], references: [id])
  planId                    String
  date                      DateTime
  time                      String
  location                  String
  type                      String // 'near_miss', 'first_aid', 'medical_treatment', 'lost_time', 'fatality'
  description               String
  involved                  String[] // User IDs
  witnesses                 String[] // User IDs
  injuries                  Json[]
  immediateActions          String
  rootCause                 String?
  preventativeMeasures      String?
  reportedById              String // User ID
  reportedDate              DateTime
  reportNumber              String
  status                    String // 'reported', 'investigating', 'resolved', 'closed'
  investigationFindings     String?
  correctiveActions         Json[]
  documentIds               String[] // Document IDs
  reportedToAuthorities     Boolean             @default(false)
  reportedToAuthoritiesDate DateTime?
  authorityReference        String?
}

model TrainingRecord {
  id                  String              @id @default(cuid())
  healthAndSafetyPlan HealthAndSafetyPlan @relation(fields: [planId], references: [id])
  planId              String
  trainingType        String
  description         String
  trainer             String
  trainingDate        DateTime
  expiryDate          DateTime?
  attendees           Json[]
  documentIds         String[] // Document IDs
  notes               String?
}

model ToolboxTalk {
  id                  String              @id @default(cuid())
  healthAndSafetyPlan HealthAndSafetyPlan @relation(fields: [planId], references: [id])
  planId              String
  topic               String
  presenterId         String // User ID
  date                DateTime
  duration            Int // in minutes
  location            String
  content             String
  attendees           String[] // User IDs
  signatures          String[]
  documentIds         String[] // Document IDs
  notes               String?
}

// ======= Investor =======

model Investment {
  id             String      @id @default(cuid())
  investor       User        @relation("InvestorRelation", fields: [investorId], references: [id])
  investorId     String
  development    Development @relation(fields: [developmentId], references: [id])
  developmentId  String
  unitIds        String[] // Unit IDs
  investmentType String // InvestmentType enum in the TypeScript model
  status         String // InvestmentStatus enum in the TypeScript model

  // Financial details
  amount             Float
  currency           String  @default("EUR")
  equity             Float? // percentage
  ownershipStructure String?
  expectedReturn     Float
  projectedIRR       Float?
  projectMultiple    Float?

  // Timeline
  commitmentDate DateTime
  fundingDate    DateTime
  dueDate        DateTime?
  exitDate       DateTime?

  // Associated entities
  investmentVehicleId String? // InvestmentVehicle ID
  legalEntity         String?
  coInvestorIds       String[] // User IDs

  // Documents
  investmentAgreementId String // Document ID
  termSheetId           String? // Document ID
  documentIds           String[] // Document IDs

  // Returns
  currentValue  Float
  valuationDate DateTime
  totalReturns  Float
  roi           Float

  // Status
  notes   String?
  created DateTime @default(now())
  updated DateTime @updatedAt

  // Relations
  distributions Distribution[]
  updates       InvestmentUpdate[]
}

model Distribution {
  id               String     @id @default(cuid())
  investment       Investment @relation(fields: [investmentId], references: [id])
  investmentId     String
  distributionType String // 'interest', 'dividend', 'capital_return', 'profit_share'
  amount           Float
  currency         String     @default("EUR")
  distributionDate DateTime
  description      String
  status           String // 'scheduled', 'processing', 'completed', 'cancelled'
  paymentReference String?
  documentIds      String[] // Document IDs
  taxWithheld      Float?
  netAmount        Float
}

model InvestmentUpdate {
  id               String     @id @default(cuid())
  investment       Investment @relation(fields: [investmentId], references: [id])
  investmentId     String
  updateDate       DateTime
  title            String
  content          String
  authorId         String // User ID
  isPublic         Boolean    @default(true)
  metrics          Json
  documentIds      String[] // Document IDs
  sentToInvestors  Boolean    @default(false)
  acknowledgements Json[]
}

model InvestmentOpportunity {
  id            String      @id @default(cuid())
  title         String
  development   Development @relation(fields: [developmentId], references: [id])
  developmentId String
  description   String
  status        String // OpportunityStatus enum in the TypeScript model

  // Financial details
  minimumInvestment Float
  targetRaise       Float
  maxRaise          Float
  totalRaised       Float  @default(0)
  investmentType    String // InvestmentType enum in the TypeScript model
  projectedReturns  Json

  // Timeline
  launchDate              DateTime
  closingDate             DateTime
  constructionStartDate   DateTime?
  estimatedCompletionDate DateTime
  estimatedExitDate       DateTime

  // Marketing materials
  highlights              String[]
  riskFactors             String[]
  images                  String[]
  brochureUrl             String?
  financialProjectionsUrl String?

  // Investment terms
  investmentStructure String
  feesStructure       Json

  // Documentation
  documentIds String[] // Document IDs

  // Access and visibility
  visibleTo           String // 'all', 'accredited_only', 'selected'
  selectedInvestorIds String[] // User IDs

  // Investor activity
  viewCount           Int    @default(0)
  interestedInvestors Json[]
  commitments         Json[]

  // Metadata
  createdById String // User ID
  created     DateTime @default(now())
  updated     DateTime @updatedAt
}

model InvestorWatchlistUnit {
  id         String   @id @default(cuid())
  investorId String // User ID
  unit       Unit     @relation(fields: [unitId], references: [id])
  unitId     String
  addedDate  DateTime @default(now())
  notes      String?

  @@unique([investorId, unitId])
}

// ======= Marketing =======

model MarketingCampaign {
  id            String      @id @default(cuid())
  name          String
  development   Development @relation(fields: [developmentId], references: [id])
  developmentId String
  status        String // CampaignStatus enum in the TypeScript model

  // Campaign details
  description     String
  targetAudience  String
  objectives      String[]
  successCriteria String[]

  // Timeline
  startDate      DateTime
  endDate        DateTime?
  plannedEndDate DateTime

  // Budget and spend
  budget      Float
  actualSpend Float @default(0)

  // Performance
  performance Json

  // Management and metadata
  createdById   String // User ID
  assignedToIds String[] // User IDs
  approvedById  String? // User ID
  created       DateTime @default(now())
  updated       DateTime @updatedAt
  notes         String?
  tags          String[]

  // Relations
  channels       MarketingChannel[]
  activities     MarketingActivity[]
  creativeAssets CreativeAsset[]
  leads          Lead[]
}

model MarketingChannel {
  id         String            @id @default(cuid())
  campaign   MarketingCampaign @relation(fields: [campaignId], references: [id])
  campaignId String
  name       String
  type       String // ChannelType enum in the TypeScript model
  status     String // 'active', 'paused', 'completed'

  // Budget and spend
  budget      Float
  actualSpend Float @default(0)

  // Performance metrics
  impressions       Int   @default(0)
  clicks            Int?
  inquiries         Int   @default(0)
  cost              Float @default(0)
  costPerInquiry    Float @default(0)
  costPerImpression Float @default(0)

  // Tracking
  startDate     DateTime
  endDate       DateTime?
  trackingCodes String[]
  trackingUrls  String[]

  // Additional details
  platform        String?
  targetAudience  String?
  audienceSize    Int?
  geographicFocus String[]

  // Notes and metadata
  notes String?
  tags  String[]

  // Relations
  creativeAssets CreativeAsset[]
  activities     MarketingActivity[]
}

model MarketingActivity {
  id          String            @id @default(cuid())
  campaign    MarketingCampaign @relation(fields: [campaignId], references: [id])
  campaignId  String
  channel     MarketingChannel  @relation(fields: [channelId], references: [id])
  channelId   String
  name        String
  description String
  type        String // ActivityType enum in the TypeScript model
  status      String // 'planned', 'in_progress', 'completed', 'cancelled'

  // Timeline
  plannedStartDate DateTime
  plannedEndDate   DateTime
  actualStartDate  DateTime?
  actualEndDate    DateTime?

  // Budget and spend
  budget      Float
  actualSpend Float @default(0)

  // Details and assets
  assignedToIds   String[] // User IDs
  externalVendors String[]

  // Performance
  metrics Json?
  results String?

  // Notes and metadata
  notes   String?
  created DateTime @default(now())
  updated DateTime @updatedAt

  // Relations
  creativeAssets CreativeAsset[]
}

model CreativeAsset {
  id          String  @id @default(cuid())
  name        String
  type        String // AssetType enum in the TypeScript model
  url         String
  fileType    String
  description String?

  // Usage and metrics
  usedIn      Json
  impressions Int?
  clicks      Int?

  // Production details
  createdBy     String
  designer      String?
  agency        String?
  creationDate  DateTime
  expiryDate    DateTime?
  versionNumber String

  // Status and rights
  status            String // 'draft', 'review', 'approved', 'active', 'archived'
  approvedById      String? // User ID
  approvedDate      DateTime?
  rightsInformation String?
  usage             String // 'unlimited', 'limited'
  usageRights       String?

  // Tagging and metadata
  tags         String[]
  dimensions   String?
  size         Int? // in KB
  thumbnailUrl String?

  // Relations
  campaigns  MarketingCampaign[]
  channels   MarketingChannel[]
  activities MarketingActivity[]
}

model Lead {
  id          String             @id @default(cuid())
  source      String
  campaign    MarketingCampaign? @relation(fields: [campaignId], references: [id])
  campaignId  String?
  channel     String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmContent  String?
  utmTerm     String?

  // Personal information
  firstName String
  lastName  String
  email     String
  phone     String?
  address   String?

  // Lead details
  status        String // LeadStatus enum in the TypeScript model
  type          String // 'buyer', 'investor', 'agent', 'other'
  priorityScore Int     @default(0)
  assignedTo    User?   @relation("AssignedLeads", fields: [assignedToId], references: [id])
  assignedToId  String?

  // Requirements
  interestedInDevelopmentIds String[] // Development IDs
  interestedInUnitIds        String[] // Unit IDs
  propertyType               String[]
  bedrooms                   Int[]
  budget                     Json?
  desiredMoveInDate          DateTime?

  // Interactions
  firstContactDate DateTime  @default(now())
  lastContactDate  DateTime?
  nextFollowUpDate DateTime?
  documentIds      String[] // Document IDs
  notes            String[]

  // Conversion
  convertedToSaleId String? // Sale ID
  conversionDate    DateTime?

  // Timestamps and metadata
  created DateTime @default(now())
  updated DateTime @updatedAt
  tags    String[]

  // Relations
  statusHistory LeadStatusHistory[]
  interactions  LeadInteraction[]
  viewings      Viewing[]
}

model LeadStatusHistory {
  id        String   @id @default(cuid())
  lead      Lead     @relation(fields: [leadId], references: [id])
  leadId    String
  status    String // LeadStatus enum in the TypeScript model
  timestamp DateTime @default(now())
  note      String?
  userId    String // User ID
}

model LeadInteraction {
  id        String   @id @default(cuid())
  lead      Lead     @relation(fields: [leadId], references: [id])
  leadId    String
  type      String // InteractionType enum in the TypeScript model
  direction String // 'inbound', 'outbound'
  channel   String // 'email', 'phone', 'in_person', 'sms', 'social', 'web', 'other'
  date      DateTime @default(now())
  userId    String // User ID

  // Details
  subject     String?
  content     String
  duration    Int? // in minutes
  documentIds String[] // Document IDs
  location    String?

  // Outcome
  outcome              String?
  followUpRequired     Boolean   @default(false)
  followUpDate         DateTime?
  followUpAssignedToId String? // User ID

  // Metadata
  sentiment String? // 'positive', 'neutral', 'negative'
  tags      String[]
}

model Viewing {
  id            String      @id @default(cuid())
  lead          Lead        @relation(fields: [leadId], references: [id])
  leadId        String
  development   Development @relation(fields: [developmentId], references: [id])
  developmentId String
  units         Unit[]

  // Scheduling
  date      DateTime
  startTime String
  endTime   String
  duration  Int // in minutes
  type      String // 'in_person', 'virtual'
  status    String // ViewingStatus enum in the TypeScript model

  // Participants
  hostId    String // User ID
  attendees Json[]

  // Details
  location                String
  meetingPoint            String?
  virtualMeetingLink      String?
  privateParkingAvailable Boolean @default(false)
  specialRequirements     String?

  // Follow-up
  feedback Json?
  followUp Json

  // Reminders and communication
  reminderSent         Boolean   @default(false)
  reminderSentDate     DateTime?
  confirmationSent     Boolean   @default(false)
  confirmationSentDate DateTime?

  // Metadata
  created     DateTime @default(now())
  updated     DateTime @updatedAt
  createdById String // User ID
  notes       String?
}

// ======= UserRole enum mapping =======
model UserRoleMapping {
  id     String @id @default(cuid())
  userId String
  role   String // UserRole enum value

  @@unique([userId, role])
}

// ======= Transaction Management =======

model Transaction {
  id                    String              @id @default(cuid())
  referenceNumber       String              @unique
  status                TransactionStatus   @default(ENQUIRY)
  stage                 TransactionStage    @default(INITIAL_ENQUIRY)
  type                  TransactionType     @default(PURCHASE)
  
  // Core parties
  buyerId               String
  buyer                 User                @relation("BuyerTransactions", fields: [buyerId], references: [id])
  developmentId         String
  development           Development         @relation(fields: [developmentId], references: [id])
  unitId                String
  unit                  Unit                @relation(fields: [unitId], references: [id])
  
  // Secondary parties
  agentId               String?
  agent                 User?               @relation("AgentTransactions", fields: [agentId], references: [id])
  solicitorId           String?
  solicitor             User?               @relation("SolicitorTransactions", fields: [solicitorId], references: [id])
  buyerSolicitorId      String?
  
  // Financial details
  agreedPrice           Float?
  depositPaid           Float               @default(0)
  totalPaid             Float               @default(0)
  outstandingBalance    Float?
  
  // Important dates
  enquiryDate           DateTime            @default(now())
  viewingDate           DateTime?
  reservationDate       DateTime?
  contractDate          DateTime?
  mortgageApprovalDate  DateTime?
  completionDate        DateTime?
  handoverDate          DateTime?
  
  // Mortgage details
  mortgageRequired      Boolean             @default(true)
  mortgageApproved      Boolean             @default(false)
  mortgageProvider      String?
  mortgageAmount        Float?
  mortgageReference     String?
  
  // HTB details
  helpToBuyUsed         Boolean             @default(false)
  htbAmount             Float?
  htbReference          String?
  htbApplicationDate    DateTime?
  htbApprovalDate       DateTime?
  
  // Legal details
  contractsSent         Boolean             @default(false)
  contractsSigned       Boolean             @default(false)
  contractsExchanged    Boolean             @default(false)
  titleDeeds            String?
  
  // Compliance
  kycCompleted          Boolean             @default(false)
  amlCheckCompleted     Boolean             @default(false)
  sourceOfFundsVerified Boolean             @default(false)
  
  // Customizations
  customizationDeadline DateTime?
  customizationsLocked  Boolean             @default(false)
  
  // Communication preferences
  preferredContactMethod String             @default("email")
  marketingOptIn        Boolean            @default(false)
  gdprConsent           Boolean            @default(false)
  
  // Metadata
  referralSource        String?
  notes                 String?             @db.Text
  internalNotes         String?             @db.Text
  tags                  String[]
  
  // Timestamps
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  completedAt           DateTime?
  cancelledAt           DateTime?
  
  // Relations
  events                TransactionEvent[]
  documents             TransactionDocument[]
  payments              TransactionPayment[]
  tasks                 TransactionTask[]
  milestones            TransactionMilestone[]
  notifications         TransactionNotification[]
  communications        TransactionCommunication[]
  issues                TransactionIssue[]
  customizations        CustomizationSelection[]
  timeline              TransactionTimeline?
  analyticsPayments     Payment[]
  
  @@index([buyerId])
  @@index([unitId])
  @@index([developmentId])
  @@index([status])
  @@index([stage])
  @@index([referenceNumber])
}

enum TransactionStatus {
  ENQUIRY
  VIEWING_SCHEDULED
  VIEWED
  INTERESTED
  OFFER_MADE
  OFFER_ACCEPTED
  RESERVATION_PENDING
  RESERVED
  SALE_AGREED
  CONTRACTS_ISSUED
  CONTRACTS_SIGNED
  MORTGAGE_APPLIED
  MORTGAGE_APPROVED
  FUNDS_RELEASED
  COMPLETION_PENDING
  COMPLETED
  HANDED_OVER
  CANCELLED
  WITHDRAWN
  FALLEN_THROUGH
}

enum TransactionStage {
  INITIAL_ENQUIRY
  PROPERTY_VIEWING
  OFFER_NEGOTIATION
  RESERVATION
  LEGAL_PROCESSING
  MORTGAGE_APPLICATION
  CONTRACT_EXCHANGE
  PRE_COMPLETION
  COMPLETION
  POST_COMPLETION
}

enum TransactionType {
  PURCHASE
  RESERVATION
  ASSIGNMENT
  INVESTOR_PURCHASE
}

// Transaction Events for audit trail
model TransactionEvent {
  id              String                  @id @default(cuid())
  transactionId   String
  transaction     Transaction             @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  eventType       TransactionEventType
  description     String
  metadata        Json?
  performedBy     String?
  performedAt     DateTime                @default(now())
  ipAddress       String?
  userAgent       String?
  
  @@index([transactionId])
  @@index([eventType])
  @@index([performedAt])
}

enum TransactionEventType {
  STATUS_CHANGE
  STAGE_CHANGE
  DOCUMENT_UPLOADED
  DOCUMENT_SIGNED
  PAYMENT_RECEIVED
  PAYMENT_REFUNDED
  VIEWING_SCHEDULED
  VIEWING_COMPLETED
  OFFER_MADE
  OFFER_ACCEPTED
  OFFER_REJECTED
  RESERVATION_CONFIRMED
  CONTRACT_ISSUED
  CONTRACT_SIGNED
  CONTRACT_EXCHANGED
  MORTGAGE_UPDATE
  HTB_UPDATE
  CUSTOMIZATION_SELECTED
  TASK_CREATED
  TASK_COMPLETED
  ISSUE_RAISED
  ISSUE_RESOLVED
  NOTE_ADDED
  COMMUNICATION_SENT
  MILESTONE_REACHED
}

// Transaction Documents
model TransactionDocument {
  id              String              @id @default(cuid())
  transactionId   String
  transaction     Transaction         @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  name            String
  type            TransactionDocumentType
  category        TransactionDocumentCategory
  status          TransactionDocumentStatus @default(PENDING)
  
  // File details
  fileName        String
  fileSize        Int
  mimeType        String
  fileUrl         String
  
  // Metadata
  version         Int                 @default(1)
  description     String?
  tags            String[]
  
  // Security
  isConfidential  Boolean             @default(false)
  accessLevel     String              @default("buyer")
  
  // Workflow
  requiresSignature Boolean           @default(false)
  signedBy          String[]
  signedAt          DateTime[]
  
  // Tracking
  uploadedBy      String
  uploadedAt      DateTime            @default(now())
  lastAccessedBy  String?
  lastAccessedAt  DateTime?
  
  @@index([transactionId])
  @@index([type])
  @@index([status])
}

enum TransactionDocumentType {
  IDENTIFICATION
  PROOF_OF_ADDRESS
  PROOF_OF_FUNDS
  BANK_STATEMENT
  PAYSLIP
  EMPLOYMENT_LETTER
  RESERVATION_FORM
  SALES_CONTRACT
  MORTGAGE_OFFER
  HTB_APPROVAL
  SURVEY_REPORT
  VALUATION_REPORT
  BER_CERTIFICATE
  TITLE_DEED
  COMPLETION_CERTIFICATE
  SNAG_LIST
  WARRANTY
  OTHER
}

enum TransactionDocumentCategory {
  KYC_AML
  FINANCIAL
  LEGAL
  PROPERTY
  MORTGAGE
  HTB
  COMPLETION
  WARRANTY
}

enum TransactionDocumentStatus {
  PENDING
  UPLOADED
  UNDER_REVIEW
  APPROVED
  REJECTED
  SIGNED
  EXPIRED
}

// Transaction Payments
model TransactionPayment {
  id              String              @id @default(cuid())
  transactionId   String
  transaction     Transaction         @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  type            TransactionPaymentType
  amount          Float
  currency        String              @default("EUR")
  status          TransactionPaymentStatus @default(PENDING)
  
  // Payment details
  method          PaymentMethod
  reference       String              @unique
  
  // Banking details
  fromAccount     String?
  toAccount       String?
  bankReference   String?
  
  // Processing
  processingFee   Float?
  netAmount       Float?
  
  // Important dates
  dueDate         DateTime?
  paidDate        DateTime?
  clearedDate     DateTime?
  
  // Metadata
  description     String?
  invoiceNumber   String?
  receiptUrl      String?
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  @@index([transactionId])
  @@index([status])
  @@index([reference])
}

enum TransactionPaymentType {
  BOOKING_DEPOSIT
  RESERVATION_FEE
  CONTRACT_DEPOSIT
  STAGE_PAYMENT
  BALANCE_PAYMENT
  CUSTOMIZATION_PAYMENT
  LEGAL_FEE
  STAMP_DUTY
  REGISTRATION_FEE
  MORTGAGE_DEPOSIT
  HTB_DEPOSIT
  REFUND
  OTHER
}

enum TransactionPaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
  DISPUTED
}

enum PaymentMethod {
  BANK_TRANSFER
  CREDIT_CARD
  DEBIT_CARD
  CHEQUE
  CASH
  MORTGAGE_DRAWDOWN
  HTB_SCHEME
  CRYPTO
  OTHER
}

// Transaction Tasks
model TransactionTask {
  id              String              @id @default(cuid())
  transactionId   String
  transaction     Transaction         @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  title           String
  description     String?             @db.Text
  category        TransactionTaskCategory
  priority        TransactionTaskPriority @default(NORMAL)
  status          TransactionTaskStatus   @default(PENDING)
  
  // Assignment
  assignedTo      String?
  assignedBy      String?
  
  // Dates
  dueDate         DateTime?
  startedAt       DateTime?
  completedAt     DateTime?
  
  // Dependencies
  dependsOn       String[]            // Task IDs this task depends on
  blockedBy       String[]            // Task IDs blocking this task
  
  // Automation
  isAutomated     Boolean             @default(false)
  automationRule  String?
  
  // Tracking
  estimatedHours  Float?
  actualHours     Float?
  notes           String?
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  @@index([transactionId])
  @@index([status])
  @@index([assignedTo])
  @@index([dueDate])
}

enum TransactionTaskCategory {
  DOCUMENTATION
  FINANCIAL
  LEGAL
  PROPERTY_INSPECTION
  MORTGAGE
  HTB
  CUSTOMIZATION
  COMMUNICATION
  COMPLIANCE
  ADMINISTRATIVE
}

enum TransactionTaskPriority {
  LOW
  NORMAL
  HIGH
  URGENT
  CRITICAL
}

enum TransactionTaskStatus {
  PENDING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
  OVERDUE
}

// Transaction Milestones
model TransactionMilestone {
  id              String              @id @default(cuid())
  transactionId   String
  transaction     Transaction         @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  name            String
  description     String?
  stage           TransactionStage
  order           Int
  
  status          TransactionMilestoneStatus @default(PENDING)
  
  // Completion criteria
  requiredTasks   String[]            // Task IDs that must be completed
  requiredDocs    String[]            // Document types required
  requiredPayments String[]           // Payment types required
  
  // Dates
  targetDate      DateTime?
  actualDate      DateTime?
  
  // Automation
  autoComplete    Boolean             @default(false)
  completionRule  String?
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  @@index([transactionId])
  @@index([stage])
  @@index([order])
}

enum TransactionMilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
  BLOCKED
}

// Transaction Communications
model TransactionCommunication {
  id              String              @id @default(cuid())
  transactionId   String
  transaction     Transaction         @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  type            CommunicationType
  direction       CommunicationDirection
  
  // Participants
  fromId          String
  toId            String
  ccIds           String[]            @default([])
  
  // Content
  subject         String?
  content         String              @db.Text
  attachments     Json?               // Array of attachment details
  
  // Status
  status          CommunicationStatus @default(SENT)
  readAt          DateTime?
  
  // Metadata
  channel         String              // email, sms, in-app, phone
  threadId        String?             // For grouping related communications
  externalId      String?             // External system reference
  
  createdAt       DateTime            @default(now())
  
  @@index([transactionId])
  @@index([type])
  @@index([threadId])
  @@index([createdAt])
}

enum CommunicationType {
  EMAIL
  SMS
  PHONE_CALL
  VIDEO_CALL
  MEETING
  NOTE
  LETTER
  NOTIFICATION
}

enum CommunicationDirection {
  INBOUND
  OUTBOUND
  INTERNAL
}

enum CommunicationStatus {
  DRAFT
  SENT
  DELIVERED
  READ
  REPLIED
  BOUNCED
  FAILED
}

// Transaction Notifications
model TransactionNotification {
  id              String              @id @default(cuid())
  transactionId   String
  transaction     Transaction         @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  type            NotificationType
  priority        NotificationPriority @default(NORMAL)
  
  recipient       String              // User ID
  title           String
  message         String              @db.Text
  actionUrl       String?
  
  // Status
  status          NotificationStatus  @default(PENDING)
  sentAt          DateTime?
  readAt          DateTime?
  
  // Delivery
  channels        String[]            @default(["IN_APP"])
  emailSent       Boolean             @default(false)
  smsSent         Boolean             @default(false)
  pushSent        Boolean             @default(false)
  
  // Retry logic
  retryCount      Int                 @default(0)
  maxRetries      Int                 @default(3)
  nextRetryAt     DateTime?
  
  // Metadata
  metadata        Json?
  expiresAt       DateTime?
  
  createdAt       DateTime            @default(now())
  
  @@index([transactionId])
  @@index([recipient])
  @@index([status])
  @@index([createdAt])
}

enum NotificationType {
  STATUS_UPDATE
  DOCUMENT_REQUEST
  PAYMENT_REMINDER
  TASK_ASSIGNMENT
  MILESTONE_REACHED
  ISSUE_ALERT
  DEADLINE_REMINDER
  GENERAL_UPDATE
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
  EXPIRED
}

// Transaction Issues
model TransactionIssue {
  id              String              @id @default(cuid())
  transactionId   String
  transaction     Transaction         @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  title           String
  description     String              @db.Text
  category        TransactionIssueCategory
  severity        TransactionIssueSeverity @default(MEDIUM)
  status          TransactionIssueStatus   @default(OPEN)
  
  // Tracking
  reportedBy      String
  assignedTo      String?
  resolvedBy      String?
  
  // Dates
  reportedAt      DateTime            @default(now())
  resolvedAt      DateTime?
  dueDate         DateTime?
  
  // Resolution
  resolution      String?             @db.Text
  rootCause       String?
  preventiveMeasures String?          @db.Text
  
  // Impact
  impactedStage   TransactionStage?
  impactedTasks   String[]
  estimatedDelay  Int?                // in days
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  @@index([transactionId])
  @@index([status])
  @@index([category])
  @@index([severity])
}

enum TransactionIssueCategory {
  DOCUMENTATION
  PAYMENT
  LEGAL
  TECHNICAL
  COMMUNICATION
  COMPLIANCE
  PROPERTY
  MORTGAGE
  HTB
  OTHER
}

enum TransactionIssueSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TransactionIssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
  REOPENED
  ESCALATED
}

// Transaction Timeline
model TransactionTimeline {
  id                  String          @id @default(cuid())
  transactionId       String          @unique
  transaction         Transaction     @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  // Key dates
  firstContactDate    DateTime?
  propertyViewingDate DateTime?
  offerMadeDate       DateTime?
  offerAcceptedDate   DateTime?
  reservationDate     DateTime?
  contractIssuedDate  DateTime?
  contractSignedDate  DateTime?
  mortgageAppliedDate DateTime?
  mortgageApprovedDate DateTime?
  exchangeDate        DateTime?
  completionDueDate   DateTime?
  completionActualDate DateTime?
  keysHandoverDate    DateTime?
  moveInDate          DateTime?
  
  // Milestones with durations
  enquiryToViewingDays      Int?
  viewingToOfferDays        Int?
  offerToReservationDays    Int?
  reservationToContractDays Int?
  contractToMortgageDays    Int?
  mortgageToExchangeDays    Int?
  exchangeToCompletionDays  Int?
  totalDurationDays         Int?
  
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
}

// ======= Conveyancing Models =======

model ConveyancingCase {
  id            String             @id @default(cuid())
  caseReference String             @unique
  propertyId    String
  status        ConveyancingStatus @default(NEW)
  type          ConveyancingType   @default(PURCHASE)

  // Parties
  solicitorId String
  buyerId     String?
  sellerId    String?
  agentId     String?

  // Property Details
  propertyAddress String
  purchasePrice   Float
  depositAmount   Float
  stampDuty       Float?

  // Key Dates
  instructionDate    DateTime  @default(now())
  proposedCompletion DateTime?
  actualCompletion   DateTime?

  // Tasks & Documents
  tasks     ConveyancingTask[]
  documents ConveyancingDocument[]
  notes     ConveyancingNote[]

  // Financials
  fees     LegalFee[]
  invoices ConveyancingInvoice[]

  // Compliance
  amlCheck      AMLCheck?
  sourceOfFunds SourceOfFunds[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ConveyancingStatus {
  NEW
  INSTRUCTION_RECEIVED
  DUE_DILIGENCE
  CONTRACT_PREP
  CONTRACT_ISSUED
  CONTRACT_NEGOTIATION
  CONTRACT_SIGNED
  DEPOSIT_RECEIVED
  COMPLETION_PENDING
  COMPLETED
  ABORTED
}

enum ConveyancingType {
  PURCHASE
  SALE
  REMORTGAGE
  TRANSFER
}

model ConveyancingTask {
  id     String           @id @default(cuid())
  caseId String
  case   ConveyancingCase @relation(fields: [caseId], references: [id])

  title       String
  description String?
  category    TaskCategory
  priority    Priority     @default(MEDIUM)
  status      TaskStatus   @default(PENDING)

  assignedTo    String?
  dueDate       DateTime?
  completedDate DateTime?

  dependsOn String[] // Task IDs this task depends on
  blockedBy String[] // Task IDs blocking this task

  documents ConveyancingDocument[]
  comments  TaskComment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum TaskCategory {
  DUE_DILIGENCE
  CONTRACT_PREPARATION
  SEARCHES
  FINANCIAL
  COMPLIANCE
  COMMUNICATION
  COMPLETION
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  BLOCKED
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model ConveyancingDocument {
  id     String            @id @default(cuid())
  caseId String
  case   ConveyancingCase  @relation(fields: [caseId], references: [id])
  taskId String?
  task   ConveyancingTask? @relation(fields: [taskId], references: [id])

  name     String
  type     ConveyancingDocumentType
  fileName String
  fileUrl  String
  fileSize Int
  mimeType String

  status  ConveyancingDocumentStatus @default(DRAFT)
  version Int                        @default(1)

  uploadedBy String
  uploadedAt DateTime @default(now())

  // Document metadata
  metadata Json?

  // Security
  isConfidential Boolean @default(false)
  accessControl  Json? // Who can access this document

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ConveyancingDocumentType {
  CONTRACT
  TITLE_DEED
  SEARCH_RESULT
  AML_CHECK
  PROOF_OF_FUNDS
  IDENTITY_VERIFICATION
  MORTGAGE_OFFER
  BUILDING_REPORT
  PLANNING_PERMISSION
  CORRESPONDENCE
  OTHER
}

enum ConveyancingDocumentStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
  FINAL
}

model ConveyancingNote {
  id     String           @id @default(cuid())
  caseId String
  case   ConveyancingCase @relation(fields: [caseId], references: [id])

  content   String
  type      NoteType @default(GENERAL)
  isPrivate Boolean  @default(false)

  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum NoteType {
  GENERAL
  LEGAL
  CLIENT_COMMUNICATION
  INTERNAL
  WARNING
}

model AMLCheck {
  id     String           @id @default(cuid())
  caseId String           @unique
  case   ConveyancingCase @relation(fields: [caseId], references: [id])

  clientId String
  status   AMLStatus @default(PENDING)

  // ID Verification
  idVerificationStatus VerificationStatus @default(PENDING)
  idDocuments          Json[]

  // Address Verification
  addressVerificationStatus VerificationStatus @default(PENDING)
  addressDocuments          Json[]

  // PEP & Sanctions
  pepCheckStatus       CheckStatus @default(PENDING)
  sanctionsCheckStatus CheckStatus @default(PENDING)

  // Risk Assessment
  riskLevel   RiskLevel @default(MEDIUM)
  riskFactors Json?

  completedBy String?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AMLStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  REFERRED
}

enum VerificationStatus {
  PENDING
  VERIFIED
  FAILED
  MANUAL_REVIEW
}

enum CheckStatus {
  PENDING
  CLEAR
  HIT
  REVIEW_REQUIRED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  UNACCEPTABLE
}

model SourceOfFunds {
  id     String           @id @default(cuid())
  caseId String
  case   ConveyancingCase @relation(fields: [caseId], references: [id])

  source   FundSource
  amount   Float
  currency String     @default("EUR")

  verificationStatus VerificationStatus @default(PENDING)
  documents          Json[]
  notes              String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum FundSource {
  SALARY
  SAVINGS
  INVESTMENT
  INHERITANCE
  GIFT
  PROPERTY_SALE
  BUSINESS_INCOME
  LOAN
  OTHER
}

model LegalFee {
  id     String           @id @default(cuid())
  caseId String
  case   ConveyancingCase @relation(fields: [caseId], references: [id])

  description String
  category    FeeCategory
  amount      Float
  vatRate     Float       @default(0.23)
  vatAmount   Float
  totalAmount Float

  status FeeStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum FeeCategory {
  PROFESSIONAL_FEE
  DISBURSEMENT
  SEARCH_FEE
  REGISTRATION_FEE
  STAMP_DUTY
  OTHER
}

enum FeeStatus {
  PENDING
  INVOICED
  PAID
  WAIVED
}

model ConveyancingInvoice {
  id     String           @id @default(cuid())
  caseId String
  case   ConveyancingCase @relation(fields: [caseId], references: [id])

  invoiceNumber String @unique
  clientId      String

  subtotal    Float
  vatAmount   Float
  totalAmount Float

  status InvoiceStatus @default(DRAFT)

  issuedDate DateTime?
  dueDate    DateTime?
  paidDate   DateTime?

  lineItems Json[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  SENT
  VIEWED
  PAID
  OVERDUE
  CANCELLED
}

// ======= Development & Property Management =======

// Core Development model

// Unit Types (1 bed, 2 bed, 3 bed, 4 bed)
model UnitType {
  id            String      @id @default(cuid())
  developmentId String
  development   Development @relation(fields: [developmentId], references: [id])

  name      String // e.g., "2 Bed Apartment"
  bedrooms  Int
  bathrooms Float // 2.5 for 2 and a half bathrooms
  type      PropertyType

  // Sizing
  area Float // Square meters

  // Pricing
  priceFrom Float

  // Inventory
  totalUnits     Int
  availableUnits Int @default(0)

  // Features
  features String[] // Array of features

  // Relationships
  units      Unit[]
  schedule   ScheduleOfAccommodation[]
  floorPlans FloorPlan[]
  developmentUnits DevelopmentUnit[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([developmentId, name])
}

// Individual Units

// Schedule of Accommodation
model ScheduleOfAccommodation {
  id         String   @id @default(cuid())
  unitTypeId String
  unitType   UnitType @relation(fields: [unitTypeId], references: [id])

  room String // e.g., "Living/Kitchen/Dining", "Master Bedroom"
  area Float // Square meters

  order Int // For display ordering

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([unitTypeId, room])
}

// Floor Plans
model FloorPlan {
  id         String   @id @default(cuid())
  unitTypeId String
  unitType   UnitType @relation(fields: [unitTypeId], references: [id])

  imageUrl  String
  title     String?
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Development Media (images, videos, virtual tours)
model DevelopmentMedia {
  id            String      @id @default(cuid())
  developmentId String
  development   Development @relation(fields: [developmentId], references: [id])

  type        MediaType
  url         String
  title       String?
  description String?
  order       Int       @default(0)
  isPrimary   Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Documents (brochures, price lists, etc.)
model DevelopmentDocument {
  id            String      @id @default(cuid())
  developmentId String
  development   Development @relation(fields: [developmentId], references: [id])

  type     DocumentType
  title    String
  url      String
  isPublic Boolean      @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Amenities
model Amenity {
  id            String      @id @default(cuid())
  developmentId String
  development   Development @relation(fields: [developmentId], references: [id])

  type     AmenityType
  name     String
  distance String? // e.g., "5 min drive"
  icon     String? // Icon identifier

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Viewings

// Reservations

// Sales

// Customizations
model Customization {
  id     String @id @default(cuid())
  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id])

  category       String // e.g., "Kitchen", "Flooring", "Bathroom"
  item           String // e.g., "Cabinet Color", "Floor Type"
  value          String // e.g., "Oak", "Marble"
  additionalCost Float  @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Development-specific Enums

enum MediaType {
  IMAGE
  VIDEO
  VIRTUAL_TOUR
  FLOOR_PLAN
}

enum DocumentType {
  BROCHURE
  PRICE_LIST
  SPECIFICATION
  CONTRACT
  OTHER
}

enum AmenityType {
  SHOPPING
  EDUCATION
  TRANSPORT
  HEALTHCARE
  LEISURE
  DINING
}

enum ViewingStatus {
  REQUESTED
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum ReservationStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  CONVERTED_TO_SALE
}

// ======= Enhanced Development Models =======

model DevelopmentUnit {
  id                    String              @id @default(cuid())
  developmentId         String              
  development           Development         @relation(fields: [developmentId], references: [id])
  unitTypeId            String              
  unitType              UnitType            @relation(fields: [unitTypeId], references: [id])
  
  // Unit identification
  unitNumber            String              // e.g., "A101", "B205"
  block                 String?             // Building/block identifier
  floor                 Int                 // Floor number
  
  // Status and pricing
  status                DevelopmentUnitStatus @default(AVAILABLE)
  currentPrice          Float               // Can be different from base price
  
  // Specific unit details
  orientation           String?             // North, South, East, West
  aspect                String?             // Front, Rear, Dual
  viewType             String?             // Park, Sea, City, etc.
  
  // Garden/Balcony (if applicable)
  balconyArea          Float?              // in sq meters
  terraceArea          Float?              // in sq meters
  gardenArea           Float?              // in sq meters
  
  // Dates
  estimatedCompletionDate DateTime?
  actualCompletionDate   DateTime?
  customizationDeadline  DateTime?
  
  // Optional variations from standard unit type
  floorplanVariation    String?             // e.g., "Mirror", "Extended Kitchen"
  features              String[]            // Additional features specific to this unit
  
  // Relations
  reservations          DevelopmentReservation[]
  viewings              DevelopmentViewing[]
  sales                 DevelopmentSale[]
  
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  
  @@unique([developmentId, unitNumber])
}

model DevelopmentAmenity {
  id                    String              @id @default(cuid())
  developmentId         String              
  development           Development         @relation(fields: [developmentId], references: [id])
  
  name                  String              // e.g., "Community Centre", "Gym"
  category              AmenityCategory     // Type of amenity
  description           String?
  location              String?             // Specific location within development
  
  // Status
  isCompleted           Boolean             @default(false)
  completionDate        DateTime?
  estimatedCompletionDate DateTime?
  
  // Features
  features              String[]            // Specific features of the amenity
  openingHours          Json?               // Structured opening hours
  rules                 String[]            // Usage rules/restrictions
  
  // Media
  images                String[]
  icon                  String?             // Icon identifier for UI
  
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
}

model DevelopmentViewing {
  id                    String              @id @default(cuid())
  developmentId         String              
  development           Development         @relation(fields: [developmentId], references: [id])
  unitId               String?             
  unit                 DevelopmentUnit?    @relation(fields: [unitId], references: [id])
  
  // Viewer details
  viewerId             String              // User ID of the viewer
  viewer               User                @relation(fields: [viewerId], references: [id])
  
  // Viewing details
  scheduledDate        DateTime
  actualDate           DateTime?
  duration             Int                 @default(30) // Duration in minutes
  status               ViewingStatus       @default(REQUESTED)
  type                 ViewingType         // Physical, Virtual, Show House
  
  // Notes and feedback
  notes                String?
  feedback             Json?               // Structured feedback
  interestedLevel      Int?                // 1-5 scale
  followUpRequired     Boolean             @default(false)
  
  // Agent handling the viewing
  agentId              String?             // User ID of agent
  agent                User?               @relation("ViewingAgent", fields: [agentId], references: [id])
  
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
}

model DevelopmentReservation {
  id                    String              @id @default(cuid())
  developmentId         String              
  development           Development         @relation(fields: [developmentId], references: [id])
  unitId               String              
  unit                 DevelopmentUnit     @relation(fields: [unitId], references: [id])
  
  // Buyer details
  buyerId              String              // User ID of buyer
  buyer                User                @relation(fields: [buyerId], references: [id])
  
  // Reservation details
  reservationDate      DateTime            @default(now())
  expiryDate           DateTime
  depositAmount        Float
  depositPaid          Boolean             @default(false)
  depositPaidDate      DateTime?
  
  // Status
  status               DevelopmentReservationStatus @default(ACTIVE)
  
  // Pricing
  agreedPrice          Float
  specialConditions    String[]
  
  // References
  referenceNumber      String              @unique
  
  // Relations
  notes                String?
  
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
}

model DevelopmentSale {
  id                    String              @id @default(cuid())
  developmentId         String              
  development           Development         @relation(fields: [developmentId], references: [id])
  unitId               String              
  unit                 DevelopmentUnit     @relation(fields: [unitId], references: [id])
  
  // Buyer details
  buyerId              String              // User ID of buyer
  buyer                User                @relation(fields: [buyerId], references: [id])
  
  // Sale details
  saleDate             DateTime
  agreedPrice          Float
  deposit              Json                // Structured deposit information
  contractSigned       Boolean             @default(false)
  contractSignedDate   DateTime?
  
  // Completion
  completionDate       DateTime?
  keysHandedOver       Boolean             @default(false)
  handoverDate         DateTime?
  
  // Additional details
  solicitor            String?
  mortgageProvider     String?
  mortgageApproved     Boolean             @default(false)
  stampDutyPaid        Boolean             @default(false)
  
  // HTB
  htbUsed              Boolean             @default(false)
  htbAmount            Float?
  
  // References
  referenceNumber      String              @unique
  
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
}

// Additional Enums
enum DevelopmentUnitStatus {
  AVAILABLE
  RESERVED
  SALE_AGREED
  SOLD
  COMPLETED
  WITHDRAWN
}

enum DevelopmentReservationStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  CONVERTED
}

enum ViewingType {
  PHYSICAL
  VIRTUAL
  SHOW_HOUSE
  OPEN_DAY
}

enum AmenityCategory {
  RECREATION     // Gym, Pool, Sports
  COMMUNITY      // Centre, Meeting rooms
  CHILDREN       // Playground, Nursery
  LANDSCAPE      // Gardens, Parks
  SECURITY       // Gates, CCTV
  PARKING        // Underground, Surface
  TRANSPORT      // Bus stop, Train
  UTILITIES      // EV charging, Bike storage
}

// Analytics Models
model PropertyView {
  id        String   @id @default(cuid())
  unitId    String
  unit      Unit     @relation(fields: [unitId], references: [id])
  userId    String?
  sessionId String?
  createdAt DateTime @default(now())
  
  @@index([unitId])
  @@index([createdAt])
}

model Inquiry {
  id        String   @id @default(cuid())
  unitId    String
  unit      Unit     @relation(fields: [unitId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  message   String?
  status    String   @default("NEW")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([unitId])
  @@index([userId])
}

model Payment {
  id            String   @id @default(cuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  amount        Float
  status        String   @default("PENDING")
  method        String?
  reference     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([transactionId])
  @@index([status])
}

model AnalyticsSchedule {
  id          String   @id @default(cuid())
  developerId String
  schedule    String   // daily, weekly, monthly
  email       String
  active      Boolean  @default(true)
  lastRun     DateTime?
  nextRun     DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([developerId])
  @@index([nextRun])
}
